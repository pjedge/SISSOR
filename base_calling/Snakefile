from collections import defaultdict
import pickle
import random

localrules: all, simlinks

samples = ['PGP1_21','PGP1_22','PGP1_A1']
chambers = list(range(1,25))
chambers_pad = ['{0:02d}'.format(c) for c in chambers]

SAMTOOLS = '/opt/biotools/samtools/1.3/bin/samtools'
HG19     = '/oasis/tscc/scratch/pedge/data/genomes/hg19/hg19.fa'
PGP1_21_dir = '/oasis/tscc/scratch/wkchu/SISSOR/PGP1_21_highoutputmem/BAM'
PGP1_22_dir = '/oasis/tscc/scratch/wkchu/SISSOR/PGP1_22/previous/BAM'
PGP1_A1_dir = '/oasis/tscc/scratch/wkchu/SISSOR/PGP1_A1/HiSeqCombinedBAM'

hg19_sizes = '''chr1	249250621
chr2	243199373
chr3	198022430
chr4	191154276
chr5	180915260
chr6	171115067
chr7	159138663
chrX	155270560
chr8	146364022
chr9	141213431
chr10	135534747
chr11	135006516
chr12	133851895
chr13	115169878
chr14	107349540
chr15	102531392
chr16	90354753
chr17	81195210
chr18	78077248
chr20	63025520
chrY	59373566
chr19	59128983
chr22	51304566
chr21	48129895'''
hg19_size_list = []
for line in hg19_sizes.split('\n'):
    c,l = line.split('\t')
    hg19_size_list.append((c,int(l)))

rule all:
    input:
        expand('pileups/{s}/ch{c}.pileup',s=samples,c=chambers),
        expand('pileups_subsample/{s}/ch{c}.pileup',s=samples,c=chambers),

short_chrom_names = set([str(x) for x in range(1,23)]+['X','Y'])
chrom_names = set(['chr'+str(x) for x in range(1,23)]+['chrX','chrY'])

def format_chrom(chrom_str):
    if chrom_str in short_chrom_names:
        chrom_str = 'chr' + chrom_str
    #assert(chrom_str in chrom_names)
    if chrom_str not in chrom_names:
        print('WARNING: chrom_str "{}" not in chrom_names'.format(chrom_str))
    return chrom_str

rule pileup_subsamples:
    params: job_name = 'pileup_subsample.{s}.{c}'
    input:
        sample_set = 'sample_set.p',
        pileup = 'pileups/{s}/ch{c}.pileup'
    output: pileup = 'pileups_subsample/{s}/ch{c}.pileup'
    run:
        sample_set = pickle.load(open(input.sample_set,"rb"))
        with open(input.pileup,'r') as inf, open(output.pileup,'w') as of:
            for line in inf:
                el = line.strip().split('\t')
                if len(el) < 4:
                    continue
                c = format_chrom(el[0])
                p = int(el[1])-1
                if p in sample_set[c]:
                    print(line,file=of,end='')

sample_rate = 0.00001
rule create_sample_set:
    params: job_name = 'create_sample_set'
    output: pickle   = 'sample_set.p'
    run:
        sample_set = defaultdict(set)
        for chrom,l in hg19_size_list:
            for i in range(l):
                if random.random() < sample_rate:
                    sample_set[chrom].add(i)

        pickle.dump(sample_set,open(output.pickle,"wb"))

rule pileups:
    params: job_name = 'pileup.{s}.{c}'
    input:  bam = 'bams/{s}/ch{c}.bam'
    output: pileup = 'pileups/{s}/ch{c}.pileup'
    shell:
        '''
        {SAMTOOLS} mpileup --adjust-MQ 50 --max-depth 100 --output-MQ --min-MQ 30 --min-BQ 20 --fasta-ref {HG19} --output {output.pileup} {input.bam}
        '''

# simlink data to make path naming scheme consistent between PGP1_21 and PGP1_22
rule simlinks:
    run:
        for ch,chpad in zip(chambers,chambers_pad):
            shell('''
            mkdir -p bams/PGP1_21 bams/PGP1_22 bams/PGP1_A1
            ln -s {PGP1_21_dir}/PGP1_21_ch{chpad}.sorted.chr.bam bams/PGP1_21/ch{ch}.bam
            ln -s {PGP1_22_dir}/PGP1_22_ch{chpad}.sorted.bam bams/PGP1_22/ch{ch}.bam
            ln -s {PGP1_A1_dir}/PGP1_A1_ch{chpad}.sorted.bam bams/PGP1_A1/ch{ch}.bam
            ''')
